{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<h2 class="mb-4 text-center">Dashboard General</h2>

<!-- ====== TARJETAS RESUMEN ====== -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm p-3 text-center">
            <h5>Total de materiales</h5>
            <h2>{{ total_materiales }}</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm p-3 text-center">
            <h5>Existencias totales</h5>
            <h2>{{ total_existencias }}</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm p-3 text-center">
            <h5>Bajo stock (&lt;10)</h5>
            <h2>{{ bajo_stock }}</h2>
        </div>
    </div>
</div>

<!-- ====== GRAFICA ====== -->
<div class="card shadow p-4 mb-5">
    <h5 class="text-center mb-3">Existencias por Material</h5>
    <canvas id="stockChart" height="120"></canvas>
</div>

<!-- ====== FILTROS ====== -->
<div class="card shadow mb-4 p-3">
    <form method="get" class="row g-3">

        <div class="col-md-6">
            <input type="text" name="search" class="form-control"
                   placeholder="Buscar material..." value="{{ search_query }}">
        </div>

        <div class="col-md-4">
            <input type="text" name="type" class="form-control"
                   placeholder="Filtro por tipo..." value="{{ filter_type }}">
        </div>

        <div class="col-md-2">
            <button class="btn btn-primary w-100">Filtrar</button>
        </div>

    </form>
</div>

<!-- ====== BOTÃ“N NUEVO MATERIAL ====== -->
<div class="d-flex justify-content-end mb-2">
    {% if is_gerente %}
        <a href="{% url 'create' %}" class="btn btn-success">
            + Nuevo material
        </a>
    {% endif %}
</div>

<!-- ====== TABLA ====== -->
<div class="card shadow">
    <table class="table table-hover mb-0">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Material</th>
                <th>Disponible</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            {% for gemstone in page_obj %}
            <tr
                {% if gemstone.ammount_available < 10 %}
                    class="table-danger"
                {% elif gemstone.ammount_available < 50 %}
                    class="table-warning"
                {% else %}
                    class="table-success"
                {% endif %}
            >
                <td>{{ gemstone.id }}</td>
                <td>{{ gemstone.name }}</td>
                <td>{{ gemstone.ammount_available }}</td>
                <td class="d-flex gap-2">

                    {% if is_surtidor or is_gerente %}
                    <a href="{% url 'entry' gemstone.id %}" class="btn btn-sm btn-primary">Entrada</a>
                    <a href="{% url 'exit' gemstone.id %}" class="btn btn-sm btn-danger">Salida</a>
                    {% endif %}

                    {% if is_asistente or is_gerente %}
                    <a href="{% url 'adjustment' gemstone.id %}" class="btn btn-sm btn-warning text-dark">Ajuste</a>
                    {% endif %}

                    {% if is_gerente %}
                    <a href="{% url 'edit' gemstone.id %}" class="btn btn-sm btn-info text-white">Editar</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ====== PAGINACION ====== -->
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&type={{ filter_type }}">
                    Anterior
                </a>
            </li>
        {% endif %}

        <li class="page-item active">
            <span class="page-link">{{ page_obj.number }}</span>
        </li>

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&type={{ filter_type }}">
                    Siguiente
                </a>
            </li>
        {% endif %}
    </ul>
</nav>

<!-- ====== GRAFICA JS ====== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const ctx = document.getElementById('stockChart');

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [{% for g in gemstones %}'{{ g.name }}',{% endfor %}],
        datasets: [{
            label: 'Existencias',
            data: [{% for g in gemstones %}{{ g.ammount_available }},{% endfor %}],
            backgroundColor: [
                {% for g in gemstones %}
                    {% if g.ammount_available < 10 %}
                        'rgba(255, 99, 132, 0.7)',
                    {% elif g.ammount_available < 50 %}
                        'rgba(255, 206, 86, 0.7)',
                    {% else %}
                        'rgba(75, 192, 192, 0.7)',
                    {% endif %}
                {% endfor %}
            ]
        }]
    }
});
</script>

{% endblock %}
